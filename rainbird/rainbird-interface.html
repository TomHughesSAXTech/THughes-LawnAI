<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Rainbird Irrigation Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            margin-right: 30px;
            font-weight: 500;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.online { background: #4CAF50; }
        .status-dot.offline { background: #f44336; }

        .controls {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .zone-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .zone-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .zone-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .zone-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zone-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .zone-status {
            font-size: 0.9em;
            color: #666;
            margin-left: auto;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.danger {
            background: #f44336;
        }

        .btn.danger:hover {
            background: #da190b;
        }

        .btn.info {
            background: #2196F3;
        }

        .btn.info:hover {
            background: #0b7dda;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .response-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            border-left: 4px solid #4CAF50;
        }

        .response-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .response-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .success { color: #4CAF50; }
        .error { color: #f44336; }

        @media (max-width: 600px) {
            .zone-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Rainbird Controller</h1>
            <p>Simple Irrigation Zone Management</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot online" id="connectionStatus"></div>
                <span id="connectionText">Controller: 192.168.5.17</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot offline" id="zoneStatus"></div>
                <span id="zoneText">Status: Ready</span>
            </div>
        </div>

        <div class="controls">
            <div class="section">
                <h2>üöø Zone Controls</h2>
                <div class="zone-controls">
                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 1: Elect Boxes & BBall</div>
                            <div class="zone-status" id="zone1Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone1Duration">Duration (minutes):</label>
                            <select id="zone1Duration">
                                <option value="1">1 minute</option>
                                <option value="3">3 minutes</option>
                                <option value="5" selected>5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(1)">üöø Start Zone 1</button>
                        <button class="btn danger" onclick="stopZone(1)">‚õî Stop Zone 1</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 2: Front Lawn</div>
                            <div class="zone-status" id="zone2Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone2Duration">Duration (minutes):</label>
                            <select id="zone2Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(2)">üöø Start Zone 2</button>
                        <button class="btn danger" onclick="stopZone(2)">‚õî Stop Zone 2</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 3: Side Yard Left Side</div>
                            <div class="zone-status" id="zone3Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone3Duration">Duration (minutes):</label>
                            <select id="zone3Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(3)">üöø Start Zone 3</button>
                        <button class="btn danger" onclick="stopZone(3)">‚õî Stop Zone 3</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 4: Back Yard Fence</div>
                            <div class="zone-status" id="zone4Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone4Duration">Duration (minutes):</label>
                            <select id="zone4Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(4)">üöø Start Zone 4</button>
                        <button class="btn danger" onclick="stopZone(4)">‚õî Stop Zone 4</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 5: Back Yard Middle</div>
                            <div class="zone-status" id="zone5Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone5Duration">Duration (minutes):</label>
                            <select id="zone5Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(5)">üöø Start Zone 5</button>
                        <button class="btn danger" onclick="stopZone(5)">‚õî Stop Zone 5</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 6: Back Yard Patio</div>
                            <div class="zone-status" id="zone6Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone6Duration">Duration (minutes):</label>
                            <select id="zone6Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(6)">üöø Start Zone 6</button>
                        <button class="btn danger" onclick="stopZone(6)">‚õî Stop Zone 6</button>
                    </div>

                    <div class="zone-card">
                        <div class="zone-header">
                            <div class="zone-title">Zone 7: Side Yard HVAC Side</div>
                            <div class="zone-status" id="zone7Status">Ready</div>
                        </div>
                        <div class="input-group">
                            <label for="zone7Duration">Duration (minutes):</label>
                            <select id="zone7Duration">
                                <option value="1">1 minute</option>
                                <option value="3" selected>3 minutes</option>
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startZone(7)">üöø Start Zone 7</button>
                        <button class="btn danger" onclick="stopZone(7)">‚õî Stop Zone 7</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üõë Emergency Controls</h2>
                <button class="btn danger" onclick="stopAllZones()" style="width: 200px;">‚õî STOP ALL ZONES</button>
            </div>

            <div class="section">
                <h2>üìä System Information</h2>
                <button class="btn info" onclick="getControllerInfo()" style="width: 200px; margin-right: 10px;">‚ÑπÔ∏è Controller Info</button>
                <button class="btn info" onclick="getZoneStatus()" style="width: 200px;">üìä Zone Status</button>
            </div>

            <div class="response-area">
                <div class="response-title">üìã System Messages</div>
                <div class="response-content" id="responseArea">
                    Welcome to Rainbird Controller! Click any button to start controlling your irrigation system.
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;

        function setLoading(loading) {
            isLoading = loading;
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = loading;
            });
            if (loading) {
                document.body.classList.add('loading');
            } else {
                document.body.classList.remove('loading');
            }
        }

        function updateResponse(message, type = 'info') {
            const responseArea = document.getElementById('responseArea');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            
            responseArea.innerHTML = `<div class="${colorClass}">[${timestamp}] ${message}</div>` + responseArea.innerHTML;
        }

        function updateZoneStatus(zone, status) {
            const statusElement = document.getElementById(`zone${zone}Status`);
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        async function startZone(zoneNumber) {
            if (isLoading) return;
            
            const durationElement = document.getElementById(`zone${zoneNumber}Duration`);
            const duration = durationElement.value;
            
            setLoading(true);
            updateResponse(`üöø Starting Zone ${zoneNumber} for ${duration} minutes...`);
            updateZoneStatus(zoneNumber, 'Starting...');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch('/api/start-zone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zone: zoneNumber,
                        duration: parseInt(duration)
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.success) {
                    updateResponse(`‚úÖ ${data.message}`, 'success');
                    updateZoneStatus(zoneNumber, `Running (${duration}m)`);
                } else {
                    updateResponse(`‚ùå ${data.message}: ${data.error}`, 'error');
                    updateZoneStatus(zoneNumber, 'Error');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateResponse(`‚è±Ô∏è Request timed out - Zone ${zoneNumber} may still have started`, 'error');
                    updateZoneStatus(zoneNumber, 'Timeout');
                } else {
                    updateResponse(`‚ùå Network error: ${error.message}`, 'error');
                    updateZoneStatus(zoneNumber, 'Error');
                }
            }

            setLoading(false);
        }

        async function stopZone(zoneNumber) {
            if (isLoading) return;
            
            setLoading(true);
            updateResponse(`‚õî Stopping Zone ${zoneNumber}...`);
            updateZoneStatus(zoneNumber, 'Stopping...');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch('/api/stop-zone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zone: zoneNumber
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.success) {
                    updateResponse(`‚úÖ ${data.message}`, 'success');
                    updateZoneStatus(zoneNumber, 'Stopped');
                } else {
                    updateResponse(`‚ùå ${data.message}: ${data.error}`, 'error');
                    updateZoneStatus(zoneNumber, 'Error');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateResponse(`‚è±Ô∏è Request timed out - Zone ${zoneNumber} may still have stopped`, 'error');
                    updateZoneStatus(zoneNumber, 'Timeout');
                } else {
                    updateResponse(`‚ùå Network error: ${error.message}`, 'error');
                    updateZoneStatus(zoneNumber, 'Error');
                }
            }

            setLoading(false);
        }

        async function stopAllZones() {
            if (isLoading) return;
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to stop ALL zones?')) {
                return;
            }
            
            setLoading(true);
            updateResponse(`‚õî Stopping ALL zones...`);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/api/stop-zone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zone: 0
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.success) {
                    updateResponse(`‚úÖ ${data.message}`, 'success');
                    // Update all zone statuses to stopped (zones 1-7)
                    for (let i = 1; i <= 7; i++) {
                        updateZoneStatus(i, 'Stopped');
                    }
                } else {
                    updateResponse(`‚ùå ${data.message}: ${data.error}`, 'error');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateResponse(`‚è±Ô∏è Stop request timed out - All zones likely stopped`, 'success');
                    // Update all zone statuses to stopped anyway (zones 1-7)
                    for (let i = 1; i <= 7; i++) {
                        updateZoneStatus(i, 'Stopped');
                    }
                } else {
                    updateResponse(`‚ùå Network error: ${error.message}`, 'error');
                }
            }

            setLoading(false);
        }

        async function getControllerInfo() {
            if (isLoading) return;
            
            setLoading(true);
            updateResponse(`‚ÑπÔ∏è Getting controller information...`);

            try {
                const response = await fetch('/api/controller-info');
                const data = await response.json();

                if (data.success) {
                    updateResponse(`‚úÖ Controller Info: ${JSON.stringify(data.data, null, 2)}`, 'success');
                } else {
                    updateResponse(`‚ùå ${data.message}: ${data.error}`, 'error');
                }
            } catch (error) {
                updateResponse(`‚ùå Network error: ${error.message}`, 'error');
            }

            setLoading(false);
        }

        async function getZoneStatus() {
            if (isLoading) return;
            
            setLoading(true);
            updateResponse(`üìä Getting zone status...`);

            try {
                const response = await fetch('/api/zone-status');
                const data = await response.json();

                if (data.success) {
                    updateResponse(`‚úÖ Zone Status: ${JSON.stringify(data.data, null, 2)}`, 'success');
                } else {
                    updateResponse(`‚ùå ${data.message}: ${data.error}`, 'error');
                }
            } catch (error) {
                updateResponse(`‚ùå Network error: ${error.message}`, 'error');
            }

            setLoading(false);
        }

        // No automatic requests - user must click buttons manually
        // This prevents the interface from hanging on startup
        updateResponse('üå± Rainbird Controller Ready! Click any button to control your zones.', 'success');
    </script>
</body>
</html>
